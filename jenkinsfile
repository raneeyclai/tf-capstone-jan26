pipeline {
  agent any
  triggers {
    pollSCM('H/3 * * * *')
  }
  stages {
    stage ('Checkout'){
      steps {
        checkout SCM
      }
    }
    stage ('Check Pre-req'){
      steps {
      sh 'ls -l'
      sh 'pwd'
      sh 'terraform -version'
      sh 'aws sts get-caller-identity'
      }
    }
    stage('initialize'){
      steps{
        sh 'terraform init'
      }
    }
    stage('validate'){
      steps{
        sh 'terraform validate'
      }
    }
    // stage('Format'){
    //   steps{
    //     sh 'terraform fmt -check'
    //   }
    // }
    stage('plan') {
      steps {
        sh 'terraform plan -out=tfplan'
        sh 'terraform show -json tfplan > tfplan.json'
      }
    }
    stage('Approval') {
      steps {
          input message: 'Apply changes?', ok: 'Apply'
      }
    }
    stage('Terraform Apply') {
        steps {
            sh 'terraform apply -auto-approve'
        }
    }
    stage ('Cleanup workspace'){
      steps {
        deleteDir()
      }
    }
  }
}